#!/usr/bin/env bash
set -euo pipefail

# Load env file if present (systemd EnvironmentFile uses the same)
if [[ -f /etc/smolotchi/env ]]; then
  # shellcheck disable=SC1091
  . /etc/smolotchi/env
fi

# Defaults (can be overridden by env)
DB="${SMOLOTCHI_DB:-/var/lib/smolotchi/events.db}"
AR="${SMOLOTCHI_ARTIFACT_ROOT:-/var/lib/smolotchi/artifacts}"
CFG="${SMOLOTCHI_CONFIG:-/etc/smolotchi/config.toml}"

# Prefer explicit python path if given
PY="${SMOLOTCHI_PY:-}"

# Else derive python from repo
if [[ -z "${PY}" ]]; then
  REPO="${SMOLOTCHI_REPO:-/home/smolotchi/smolotchi}"
  if [[ -x "$REPO/.venv/bin/python" ]]; then
    PY="$REPO/.venv/bin/python"
  fi
fi

# Final fallback (dev/emergency)
if [[ -z "${PY}" ]]; then
  PY="python3"
fi

# If config path doesn't exist, fallback to repo-local config.toml if present
if [[ ! -f "$CFG" ]]; then
  REPO_FALLBACK="${SMOLOTCHI_REPO:-/home/smolotchi/smolotchi}"
  if [[ -f "$REPO_FALLBACK/config.toml" ]]; then
    CFG="$REPO_FALLBACK/config.toml"
  fi
fi

exec "$PY" -m smolotchi.cli --db "$DB" --artifact-root "$AR" --config "$CFG" "$@"
