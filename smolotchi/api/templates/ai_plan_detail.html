{% extends "layout.html" %}
{% block page_title %}AI Plan{% endblock %}
{% block page_sub %}{{ plan.id }}{% endblock %}

{% block content %}
<section class="card">
  <div class="row between">
    <a href="/ai/plans" class="btn secondary">← Back to Plans</a>
    <a class="btn secondary" href="/ai/jobs">Jobs</a>

    <form method="post" action="/ai/run">
      <input type="hidden" name="plan_artifact_id" value="{{ plan_artifact_id }}">
      <button class="btn">Run (safe)</button>
    </form>
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">Live progress</h3>
  <div class="muted">Job ID: <span id="ai-job-id">job-{{ plan.id }}</span></div>
  <pre id="ai-progress" class="pre-scroll mt-md">(waiting…)</pre>
</section>

<section class="card">
  <h3 class="h3-tight">Steps</h3>
  <div class="events">
    {% for s in plan.steps %}
      <div class="evt">
        <div class="evt-top">{{ s.action_id }}</div>
        <pre>score={{ s.score }}{% if s.why %}\nwhy: {{ s.why }}{% endif %}</pre>
      </div>
    {% else %}
      <div class="muted">No steps recorded.</div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">Explain</h3>
  <pre>{{ plan.explain | tojson(indent=2) }}</pre>
</section>

<section class="card">
  <h3 class="h3-tight">Runs</h3>
  <div class="events">
    {% for r in runs %}
        <div class="evt">
        <div class="evt-top">{{ r.title }}</div>
        <div class="muted">{{ r.id }}</div>
        <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=r.id) }}">Open run</a>
      </div>
    {% else %}
      <div class="muted">No runs yet.</div>
    {% endfor %}
  </div>
</section>

<script>
  (function(){
    const jobId = "job-{{ plan.id }}";
    const el = document.getElementById("ai-progress");
    async function tick(){
      try {
        const r = await fetch("/ai/progress?job_id=" + encodeURIComponent(jobId));
        const j = await r.json();
        const lines = (j.events || []).map(e => {
          const t = new Date((e.ts || 0) * 1000).toISOString();
          const topic = e.topic || "";
          let msg = "";
          const p = e.payload || {};
          if (topic === "ai.action.started") msg = `#${p.step} START ${p.action}`;
          else if (topic === "ai.action.done") msg = `#${p.step} DONE ${p.action} (${p.duration_s}s)`;
          else if (topic === "ai.plan.completed") msg = `PLAN DONE (${p.duration_s}s)`;
          else if (topic === "ai.plan.failed") msg = `PLAN FAILED: ${p.error}`;
          else if (topic === "ai.plan.cancelled") msg = "PLAN CANCELLED";
          else msg = topic;
          return `${t}  ${msg}`;
        });
        el.textContent = lines.join("\n") || "(no events yet)";
      } catch (e) {
        el.textContent = "(progress unavailable)";
      }
      setTimeout(tick, 1500);
    }
    tick();
  })();
</script>

<section class="card">
  <h3 class="h3-tight">Raw JSON</h3>
  <pre>{{ plan_pretty }}</pre>
</section>
{% endblock %}
