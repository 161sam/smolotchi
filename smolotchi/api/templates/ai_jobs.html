{% extends "layout.html" %}
{% block page_title %}AI Jobs{% endblock %}
{% block page_sub %}Queued / running plan executions{% endblock %}

{% block content %}
<section class="card">
  <div class="row" style="justify-content:space-between">
    <a href="{{ url_for('ai_plans') }}" class="btn secondary">← Back to AI Plans</a>
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Running</h3>
  <div class="events">
    {% for j in running %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>
        <form method="post" action="{{ url_for('ai_job_cancel', job_id=j.id) }}" style="margin-top:8px">
          <button class="btn secondary" type="submit">Cancel / Stop</button>
        </form>
        {% if run_by_job.get(j.id) %}
          <div class="btn-row" style="margin-top:8px">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No running AI jobs.</strong></p>
        <p class="muted">Kick off a plan from AI Plans to start execution.</p>
        <div class="btn-row">
          <a class="btn" href="{{ url_for('ai_plans') }}">Open AI Plans</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0 0 10px 0">Blocked (approval required)</h3>
    <a class="btn secondary" href="{{ url_for('ai_stages') }}">Open approvals</a>
  </div>
  <div class="events">
    {% for j in blocked %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>
        <form method="post" action="{{ url_for('ai_job_cancel', job_id=j.id) }}" style="margin-top:8px">
          <button class="btn secondary" type="submit">Cancel</button>
        </form>
        {% if run_by_job.get(j.id) %}
          <div class="btn-row" style="margin-top:8px">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No blocked jobs.</strong></p>
        <p class="muted">Stage approvals will appear here when a plan needs gating.</p>
        <div class="btn-row">
          <a class="btn secondary" href="{{ url_for('ai_stages') }}">Open approvals</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Queued</h3>
  <div class="events">
    {% for j in queued %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>
        <form method="post" action="{{ url_for('ai_job_cancel', job_id=j.id) }}" style="margin-top:8px">
          <button class="btn secondary" type="submit">Cancel</button>
        </form>
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No queued jobs.</strong></p>
        <p class="muted">Generate a plan or enqueue a run to get started.</p>
        <div class="btn-row">
          <a class="btn" href="{{ url_for('ai_plans') }}">Generate plan</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Done</h3>
  <div class="events">
    {% for j in done %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }}</pre>
        {% if run_by_job.get(j.id) %}
          <div class="btn-row" style="margin-top:8px">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No completed runs yet.</strong></p>
        <p class="muted">Once a plan finishes, it will show up here.</p>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Failed</h3>
  <div class="events">
    {% for j in failed %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>
        {% if run_by_job.get(j.id) %}
          <div class="btn-row" style="margin-top:8px">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No failed jobs.</strong></p>
        <p class="muted">Failures will surface here with run details.</p>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
