{% extends "layout.html" %}
{% block page_title %}Baseline Overview{% endblock %}
{% block page_sub %}{% if profile %}profile={{ profile }} · {% endif %}scope={{ scope }} · window={{ window }}{% endblock %}

{% block content %}
<section class="card">
  <div class="row between">
    <a class="pill" href="{{ url_for('lan_results') }}">LAN Results</a>
    <a class="pill" href="/lan/summary">Executive Summary</a>
    <a class="pill" href="{{ url_for('lan_baseline_diff_latest') }}">Baseline Diff (latest)</a>
    <form method="post" action="/lan/baseline/cleanup" class="inline-form">
      <button class="btn secondary" type="submit">Cleanup baseline</button>
    </form>
  </div>
</section>

<section class="card">
  <div class="row between">
    <h3 class="h3-tight">Baseline drift</h3>
    <form method="get" action="{{ url_for('lan_baseline_overview') }}" class="row">
      <input type="hidden" name="window" value="{{ window }}">
      {% if profiles %}
        <div class="muted">Profile</div>
        <select name="profile" class="input-compact">
          {% for p in profiles %}
            <option value="{{ p }}" {% if p == profile %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      {% endif %}
      <div class="muted">Scope</div>
      <select name="scope" class="input-compact">
        {% for s in scopes %}
          <option value="{{ s }}" {% if s == scope %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
        {% if not scopes %}
          <option value="{{ scope }}" selected>{{ scope }}</option>
        {% endif %}
      </select>
      <button class="btn secondary" type="submit">Apply</button>
    </form>
  </div>
  <div class="muted">
    Expected findings configured: {{ expected_count }} ·
    Drift window: last {{ window }} bundles
  </div>

  <div class="events mt-md">
    <div class="evt">
      <div class="evt-top">Missing expected (not seen in window)</div>
      {% if diff.missing_expected %}
        <div class="row mt-sm">
          {% for fid in diff.missing_expected|sort %}
            <a class="pill" href="{{ url_for('lan_results') }}?finding={{ fid }}&include_suppressed=1">{{ fid }}</a>
            <form method="post" action="{{ url_for('lan_baseline_remove') }}" class="inline-form">
              <input type="hidden" name="scope" value="{{ scope }}">
              <input type="hidden" name="profile" value="{{ profile }}">
              <input type="hidden" name="fid" value="{{ fid }}">
              <input type="hidden" name="back" value="{{ request.full_path }}">
              <button class="btn secondary" type="submit">Remove</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">none</div>
      {% endif %}
    </div>

    <div class="evt">
      <div class="evt-top">Unexpected (active)</div>
      {% if diff.unexpected_active %}
        <div class="row mt-sm">
          {% for fid in diff.unexpected_active|sort %}
            <a class="pill sev-high" href="{{ url_for('lan_results') }}?finding={{ fid }}">{{ fid }}</a>
            <form method="post" action="{{ url_for('lan_baseline_add') }}" class="inline-form">
              <input type="hidden" name="scope" value="{{ scope }}">
              <input type="hidden" name="profile" value="{{ profile }}">
              <input type="hidden" name="fid" value="{{ fid }}">
              <input type="hidden" name="back" value="{{ request.full_path }}">
              <button class="btn secondary" type="submit">Add to baseline</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">none</div>
      {% endif %}
    </div>

    <div class="evt">
      <div class="evt-top">Unexpected (suppressed)</div>
      {% if diff.unexpected_suppressed %}
        <div class="row mt-sm">
          {% for fid in diff.unexpected_suppressed|sort %}
            <a class="pill" href="{{ url_for('lan_results') }}?finding={{ fid }}&only_suppressed=1">{{ fid }}</a>
            <form method="post" action="{{ url_for('lan_baseline_add') }}" class="inline-form">
              <input type="hidden" name="scope" value="{{ scope }}">
              <input type="hidden" name="profile" value="{{ profile }}">
              <input type="hidden" name="fid" value="{{ fid }}">
              <input type="hidden" name="back" value="{{ request.full_path }}">
              <button class="btn secondary" type="submit">Add to baseline</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">none</div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
