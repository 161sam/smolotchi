{% extends "layout.html" %}
{% block page_title %}LAN Jobs{% endblock %}
{% block page_sub %}Persistent queue (SQLite){% endblock %}

{% block content %}
<section class="card">
  {% include "partials/back_to_lan.html" %}
</section>

<section class="card">
  <h3 class="mb-sm">Running</h3>
  <div class="events">
    {% for j in running %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>

        <div class="row mt-sm">
          <span class="pill">scope: {{ j.scope }}</span>
          <span class="pill">pack: {{ j.eff_pack }}</span>
          <span class="pill">rps: {{ j.eff_throttle_rps }}</span>
          <span class="pill">batch: {{ j.eff_batch_size }}</span>
          {% if j.wifi_ssid %}<span class="pill">ssid: {{ j.wifi_ssid }}</span>{% endif %}
        </div>

        {% if j.meta %}
          <pre class="muted mt-sm">meta: {{ j.meta }}</pre>
        {% endif %}

        {% if run_by_job.get(j.id) %}
          <div class="btn-row mt-sm">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}

        <form method="post" action="{{ url_for('lan_job_reset', job_id=j.id) }}" class="mt-sm">
          <button class="btn secondary" type="submit">Reset to queued</button>
        </form>
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No running LAN jobs.</strong></p>
        <p class="muted">Enqueue a LAN job to start scanning.</p>
        <div class="btn-row mt-md">
          <a class="btn" href="{{ url_for('lan') }}">Enqueue LAN job</a>
          <a class="btn secondary" href="{{ url_for('lan_results') }}">View results</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="mb-sm">Queued</h3>
  <div class="events">
    {% for j in queued %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>

        <div class="row mt-sm">
          <span class="pill">scope: {{ j.scope }}</span>
          <span class="pill">pack: {{ j.eff_pack }}</span>
          <span class="pill">rps: {{ j.eff_throttle_rps }}</span>
          <span class="pill">batch: {{ j.eff_batch_size }}</span>
          {% if j.wifi_ssid %}<span class="pill">ssid: {{ j.wifi_ssid }}</span>{% endif %}
        </div>

        {% if j.meta %}
          <pre class="muted mt-sm">meta: {{ j.meta }}</pre>
        {% endif %}

        <form method="post" action="{{ url_for('lan_job_cancel', job_id=j.id) }}" class="mt-sm">
          <button class="btn secondary" type="submit">Cancel</button>
        </form>
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No queued LAN jobs.</strong></p>
        <p class="muted">Go to LAN to enqueue a new scan job.</p>
        <div class="btn-row mt-md">
          <a class="btn" href="{{ url_for('lan') }}">Enqueue LAN job</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="mb-sm">Done</h3>
  <div class="events">
    {% for j in done %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }}</pre>

        <div class="row mt-sm">
          <span class="pill">scope: {{ j.scope }}</span>
          <span class="pill">pack: {{ j.eff_pack }}</span>
          <span class="pill">rps: {{ j.eff_throttle_rps }}</span>
          <span class="pill">batch: {{ j.eff_batch_size }}</span>
          {% if j.wifi_ssid %}<span class="pill">ssid: {{ j.wifi_ssid }}</span>{% endif %}
        </div>

        {% if j.meta %}
          <pre class="muted mt-sm">meta: {{ j.meta }}</pre>
        {% endif %}

        {% if run_by_job.get(j.id) %}
          <div class="btn-row mt-sm">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}

        <div class="btn-row mt-sm">
          <a class="btn" href="{{ url_for('lan_result_by_job') }}?job_id={{ j.id }}">Result details</a>
        </div>

        <form method="post" action="{{ url_for('lan_job_delete', job_id=j.id) }}" class="mt-sm">
          <button class="btn secondary" type="submit">Delete</button>
        </form>
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No completed LAN jobs yet.</strong></p>
        <p class="muted">Completed scans will show up here with links to results.</p>
        <div class="btn-row mt-md">
          <a class="btn secondary" href="{{ url_for('lan_results') }}">View results</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="mb-sm">Failed</h3>
  <div class="events">
    {% for j in failed %}
      <div class="evt">
        <div class="evt-top">{{ j.id }}</div>
        <pre>{{ j.kind }} • {{ j.scope }} • {{ j.note }}</pre>

        <div class="row mt-sm">
          <span class="pill">scope: {{ j.scope }}</span>
          <span class="pill">pack: {{ j.eff_pack }}</span>
          <span class="pill">rps: {{ j.eff_throttle_rps }}</span>
          <span class="pill">batch: {{ j.eff_batch_size }}</span>
          {% if j.wifi_ssid %}<span class="pill">ssid: {{ j.wifi_ssid }}</span>{% endif %}
        </div>

        {% if j.meta %}
          <pre class="muted mt-sm">meta: {{ j.meta }}</pre>
        {% endif %}

        {% if run_by_job.get(j.id) %}
          <div class="btn-row mt-sm">
            <a class="btn" href="{{ url_for('ai_run_detail', artifact_id=run_by_job[j.id]) }}">Open run</a>
          </div>
        {% endif %}

        <div class="btn-row mt-sm">
          <a class="btn" href="{{ url_for('lan_result_by_job') }}?job_id={{ j.id }}">Result details</a>
        </div>

        <form method="post" action="{{ url_for('lan_job_delete', job_id=j.id) }}" class="mt-sm">
          <button class="btn secondary" type="submit">Delete</button>
        </form>
      </div>
    {% else %}
      <div class="empty">
        <p><strong>No failed LAN jobs.</strong></p>
        <p class="muted">Failures will show up here with notes.</p>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
