{% extends "layout.html" %}
{% block page_title %}AI Run{% endblock %}
{% block page_sub %}{{ run.plan_id }} • {{ run.status }}{% endblock %}

{% block content %}
<section class="card">
  <div class="row between">
    <div class="row">
      <a href="{{ url_for('ai_jobs') }}" class="btn secondary">← Back to AI Jobs</a>
      <a href="{{ url_for('ai_plans') }}" class="btn secondary">AI Plans</a>
      {% if plan_artifact_id %}
        <a href="{{ url_for('ai_plan_detail', artifact_id=plan_artifact_id) }}" class="btn">Open Plan</a>
      {% endif %}
    </div>
    <div class="row">
      <a class="btn secondary" href="{{ url_for('artifact_download', artifact_id=run_artifact_id) }}">Download JSON</a>
    </div>
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">Summary</h3>
  <div class="row">
    <span class="pill">status: {{ run.status }}</span>
    {% if run.scope %}<span class="pill">scope: {{ run.scope }}</span>{% endif %}
    {% if run.mode %}<span class="pill">mode: {{ run.mode }}</span>{% endif %}
    {% if run.seed is not none %}<span class="pill">seed: {{ run.seed }}</span>{% endif %}
    {% if run.started_ts %}<span class="pill">started: {{ run.started_ts }}</span>{% endif %}
    {% if run.ended_ts %}<span class="pill">ended: {{ run.ended_ts }}</span>{% endif %}
  </div>

  {% if run.error %}
    <div class="evt mt-lg">
      <div class="evt-top">Error</div>
      <pre>{{ run.error }}</pre>
    </div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">Steps</h3>
  <div class="events">
    {% for s in run.steps %}
      <div class="evt">
        <div class="evt-top">
          <div class="row between">
            <span>#{{ s.step }} • {{ s.action }}</span>
            <div class="row gap-sm">
              {% for rid in (s.links.reports or []) %}
                <a class="pill" href="{{ url_for('report_view', artifact_id=rid) }}">report: {{ rid }}</a>
              {% endfor %}
              {% for aid in (s.links.artifacts or []) %}
                <a class="pill" href="{{ url_for('artifact_view', artifact_id=aid) }}">artifact: {{ aid }}</a>
              {% endfor %}
              {% for bid in (s.links.bundles or []) %}
                <a class="pill" href="{{ url_for('lan_result_details', bundle_id=bid) }}">bundle: {{ bid }}</a>
              {% endfor %}
              {% for jid in (s.links.jobs or []) %}
                <a class="pill" href="{{ url_for('lan_result_by_job') }}?job_id={{ jid }}">job: {{ jid }}</a>
              {% endfor %}

              {% if ( (s.links.reports|length) + (s.links.artifacts|length) + (s.links.bundles|length) + (s.links.jobs|length) ) == 0 %}
                <span class="muted">no links</span>
              {% endif %}
            </div>
          </div>
        </div>
        <pre>duration={{ s.duration_s }}s{% if s.score is not none %} • score={{ s.score }}{% endif %}</pre>

        {% if s.why %}
          <div class="muted mt-md">why</div>
          <pre>{{ s.why }}</pre>
        {% endif %}

        {% if s.result_summary %}
          <div class="muted mt-md">result</div>
          <pre>{{ s.result_summary | tojson(indent=2) }}</pre>
        {% endif %}
      </div>
    {% else %}
      <div class="muted">No steps recorded.</div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">Raw JSON</h3>
  <pre>{{ run_pretty }}</pre>
</section>
{% endblock %}
