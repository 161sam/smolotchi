{% extends "layout.html" %}
{% block page_title %}LAN Results{% endblock %}
{% block page_sub %}Bundles (JSON + optional HTML report){% endblock %}

{% block content %}
<section class="card">
  {% include "partials/back_to_lan.html" %}
</section>

{% if top_findings %}
<section class="card">
  <h3 style="margin:0 0 10px 0">Top Findings (recent)</h3>
  <div class="events">
    {% for f in top_findings %}
      <div class="evt">
        <div class="evt-top">
          <span class="pill sev-{{ f.severity }}">{{ f.severity|upper }}</span>
          {{ f.title }}
        </div>
        <div class="muted">
          affected hosts: {{ f.count }}
          {% if f.hosts %}
            Â· {{ f.hosts|join(", ") }}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<section class="card">
  <h3 style="margin:0 0 10px 0">Latest bundles</h3>
  <div class="events">
    {% for a in items %}
      <div class="evt">
        <div class="evt-top">{{ a.title }}</div>
        <div class="muted">bundle_id: {{ a.id }}</div>
        <div style="margin-top:10px" class="row">
          <a href="{{ url_for('lan_result_details', bundle_id=a.id) }}"
             style="color:var(--accent); text-decoration:none; font-weight:900;">Open details</a>
          <a href="{{ url_for('artifact_download', artifact_id=a.id) }}"
             style="color:var(--accent); text-decoration:none; font-weight:900;">Download bundle JSON</a>
        </div>

        {% if a.diff_badges %}
          <div class="row" style="gap:10px; margin-top:10px; flex-wrap:wrap;">
            <span class="pill">Changed: {{ a.diff_badges.changed_hosts or 0 }}</span>
            {% for k,v in (a.diff_badges.transitions or {}).items() %}
              <span class="pill">{{ k }}: {{ v }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if a.diff_summary and a.diff_summary.changed_hosts %}
          <div style="margin-top:10px">
            <div class="muted">Changed hosts</div>
            <div class="row" style="gap:10px; margin-top:6px; flex-wrap:wrap;">
              {% for h in a.diff_summary.changed_hosts %}
                <a class="pill" href="/lan/diff/host/{{ a.id }}/{{ h }}">{{ h }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="muted">No results yet. Enqueue a LAN job first.</div>
    {% endfor %}
  </div>
</section>
{% endblock %}
