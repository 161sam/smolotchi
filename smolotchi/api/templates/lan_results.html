{% extends "layout.html" %}
{% block page_title %}LAN Results{% endblock %}
{% block page_sub %}Bundles (JSON + optional HTML report){% endblock %}

{% block content %}
<section class="card">
  {% include "partials/back_to_lan.html" %}
  <div class="row mt-md">
    <a class="pill" href="{{ url_for('lan_baseline_overview') }}">Baseline</a>
    <a class="pill" href="{{ url_for('lan_baseline_diff_latest') }}">Baseline Diff</a>
  </div>
</section>

{% if finding_filter %}
<section class="card">
  <div class="row between">
    <div>
      <div class="muted">Filter active</div>
      <div class="link">
        Finding: {{ finding_filter }}
        {% if only_suppressed %}
          <span class="pill">only suppressed</span>
        {% elif include_suppressed %}
          <span class="pill">include suppressed</span>
        {% else %}
          <span class="pill">active only</span>
        {% endif %}
      </div>
    </div>
    <div class="row">
      <a class="pill" href="{{ url_for('lan_results') }}">Clear filter</a>
    </div>
  </div>
</section>
{% endif %}

{% if top_findings %}
<section class="card">
  <h3 class="mb-sm">Top Findings (recent)</h3>
  <div class="events">
    {% for f in top_findings %}
      <div class="evt">
        <div class="evt-top">
          <span class="pill sev-{{ f.severity }}">{{ f.severity|upper }}</span>
          <a href="{{ url_for('lan_results') }}?finding={{ f.id }}" class="link">
            {{ f.title }}
          </a>
          {% if f.baseline_expected is not none %}
            {% if f.baseline_expected %}
              <span class="pill">baseline</span>
            {% else %}
              <span class="pill sev-high">unexpected</span>
            {% endif %}
          {% endif %}
          <a class="pill" href="{{ url_for('lan_finding_timeline', fid=f.id) }}">Timeline</a>
          <form method="post" action="{{ url_for('lan_baseline_add') }}" class="inline-form">
            <input type="hidden" name="scope" value="{{ app_cfg.lan.default_scope if app_cfg and app_cfg.lan else '' }}">
            <input type="hidden" name="profile" value="{{ baseline_profile }}">
            <input type="hidden" name="fid" value="{{ f.id }}">
            <input type="hidden" name="back" value="{{ request.full_path }}">
            <button class="btn secondary" type="submit">Add to baseline</button>
          </form>
          {% if f.suppressed_count and f.suppressed_count > 0 %}
            <span class="muted">·</span>
            <a href="{{ url_for('lan_finding_jump', fid=f.id) }}?include_suppressed=1"
               class="pill">include suppressed</a>
            <a href="{{ url_for('lan_finding_jump', fid=f.id) }}?only_suppressed=1"
               class="pill">only suppressed</a>
          {% endif %}
        </div>
        <div class="muted">
          affected hosts: {{ f.count }}
          {% if f.hosts %}
            · {{ f.hosts|join(", ") }}
          {% endif %}

          {% if f.suppressed_count and f.suppressed_count > 0 %}
            <br>
            <span class="pill">suppressed: {{ f.suppressed_count }}</span>
            {% if f.suppressed_hosts %}
              · {{ f.suppressed_hosts|join(", ") }}
            {% endif %}
            <div class="row mt-sm">
              <a class="pill"
                 href="{{ url_for('lan_results') }}?finding={{ f.id }}&include_suppressed=1">
                include suppressed
              </a>
              <a class="pill"
                 href="{{ url_for('lan_results') }}?finding={{ f.id }}&only_suppressed=1">
                only suppressed
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<section class="card">
  <div class="row between">
    <h3 class="mb-sm">Latest bundles</h3>
    <div class="btn-row">
      <a class="btn secondary" href="/lan/summary">Executive Summary</a>
      <a class="btn secondary" href="/lan/summary.md">MD</a>
      <a class="btn secondary" href="/lan/summary.json">JSON</a>
    </div>
  </div>
  <div class="events">
    {% for a in items %}
      <div class="evt">
        <div class="evt-top">{{ a.title }}</div>
        <div class="muted">bundle_id: {{ a.id }}</div>
        {% if a._finding_state %}
          {% if a._finding_state == "active" %}
            <span class="pill sev-high">active finding</span>
          {% else %}
            <span class="pill">suppressed finding</span>
          {% endif %}
        {% endif %}
        <div class="btn-row mt-md">
          <a class="btn" href="{{ url_for('lan_result_details', bundle_id=a.id) }}">Open details</a>
          <a class="btn secondary" href="{{ url_for('artifact_download', artifact_id=a.id) }}">Download bundle JSON</a>
        </div>

        {% if a.eff %}
          <div class="row mt-sm">
            {% if a.eff.wifi_ssid %}<span class="pill">ssid: {{ a.eff.wifi_ssid }}</span>{% endif %}
            <span class="pill">pack: {{ a.eff.pack }}</span>
            <span class="pill">rps: {{ a.eff.throttle_rps }}</span>
            <span class="pill">batch: {{ a.eff.batch_size }}</span>
          </div>
        {% endif %}

        {% if a.diff_badges %}
          <div class="row mt-sm">
            <span class="pill">Changed: {{ a.diff_badges.changed_hosts or 0 }}</span>
            {% for k,v in (a.diff_badges.transitions or {}).items() %}
              <span class="pill">{{ k }}: {{ v }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if a.diff_summary and a.diff_summary.changed_hosts %}
          <div class="mt-md">
            <div class="muted">Changed hosts</div>
            <div class="row mt-sm">
              {% for h in a.diff_summary.changed_hosts %}
                <a class="pill" href="/lan/diff/host/{{ a.id }}/{{ h }}">{{ h }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty">
        <div><strong>No bundles yet.</strong></div>
        <div class="muted">Starte einen LAN Job, dann werden Bundles hier gelistet.</div>
        <div class="btn-row mt-md">
          <a class="btn" href="{{ url_for('lan') }}">Go to LAN</a>
          <a class="btn secondary" href="{{ url_for('lan_jobs') }}">View Jobs</a>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
