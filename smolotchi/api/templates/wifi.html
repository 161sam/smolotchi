{% extends "layout.html" %}
{% block page_title %}WiFi{% endblock %}
{% block page_sub %}scan + connect (lab-safe){% endblock %}

{% block content %}

{% if profiles_error %}
<section class="card">
  <div class="row between">
    <div>
      <div class="fw-900">Profiles not saved</div>
      <div class="muted">Validation failed. Check the Audit tab for details (ui.wifi.profiles.invalid).</div>
    </div>
    <a class="pill" href="{{ url_for('audit') }}">Open audit</a>
  </div>
</section>
{% endif %}

<section class="card">
  <div class="row between">
    <div>
      <div class="muted">Interface</div>
      <div class="fw-900">{{ iface }}</div>
    </div>
    <div>
      <div class="muted">IPv4</div>
      <div class="fw-900">{{ ip_cidr or "—" }}</div>
    </div>
    <div>
      <div class="muted">Derived scope</div>
      <div class="fw-900">{{ scope or "—" }}</div>
    </div>
    <div class="row">
      <a class="pill" href="{{ url_for('config') }}">Config</a>
      <a class="pill" href="{{ url_for('lan') }}">LAN</a>
      <a class="pill" href="{{ url_for('audit') }}">Audit</a>
      <form method="post" action="/wifi/disconnect" class="m-0">
        <input type="hidden" name="iface" value="{{ iface }}">
        <button class="btn secondary" type="submit">Disconnect now</button>
      </form>
    </div>
  </div>

  <div class="row mt-md gap-lg">
    <span class="pill">auto_connect: {{ "on" if auto_connect else "off" }}</span>
    {% if preferred_ssid %}
      <span class="pill">preferred: {{ preferred_ssid }}</span>
    {% endif %}
    {% if selected_profile_evt and selected_profile_evt.payload %}
      <span class="pill">profile selected: {{ selected_profile_evt.payload.get("ssid") or "—" }}</span>
    {% endif %}
    {% if conn_evt and conn_evt.payload %}
      <span class="pill">last connect: {{ conn_evt.payload.get("ssid") }} (ok={{ conn_evt.payload.get("ok") }})</span>
    {% endif %}
    {% if scan_evt and scan_evt.payload %}
      <span class="pill">last scan: {{ scan_evt.payload.get("count") }} APs</span>
    {% endif %}
    {% if health_evt and health_evt.payload %}
      <span class="pill">health: {{ "ok" if health_evt.payload.get("ok") else "bad" }}</span>
    {% endif %}
    {% if lan_locked %}
      <span class="pill">LAN lock active</span>
    {% endif %}
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">WiFi → LAN timeline</h3>
  <div class="events">
    {% for e in events[:30] %}
      {% if e.topic.startswith("wifi.") or e.topic.startswith("ui.wifi.") or e.topic.startswith("ui.lan.") or e.topic.startswith("lan.") %}
        <div class="evt">
          <div class="evt-top">{{ e.topic }}</div>
          <pre>{{ e.payload }}</pre>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">Nearby APs</h3>

  {% if aps %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>SSID</th>
            <th>BSSID</th>
            <th>Signal</th>
            <th>Seen</th>
            <th>Best</th>
            <th>Security</th>
            <th>Freq</th>
            <th>Allow</th>
            <th>Scope</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for a in aps %}
            <tr class="table-row">
              <td class="fw-900">
                {{ a.ssid or "(hidden)" }}
                {% if a._preferred %}<span class="pill">preferred</span>{% endif %}
                {% if not a._allowed %}<span class="pill">blocked</span>{% endif %}
              </td>
              <td class="muted">{{ a.bssid }}</td>
              <td>{{ a.signal }} dBm</td>
              <td>{{ a._seen_count or 0 }}</td>
              <td>{{ a._strongest if a._strongest is not none else "—" }}</td>
              <td>{{ a.sec or "unknown" }}</td>
              <td>{{ a.freq or "" }}</td>
              <td>
                {% if a.ssid and (not a._allowed) %}
                  <form method="post" action="/wifi/allowlist/add" class="m-0">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <button class="btn secondary" type="submit">Allow</button>
                  </form>
                {% elif a.ssid and a._allowed %}
                  <form method="post" action="/wifi/allowlist/remove" class="row m-0">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <button class="btn secondary" type="submit">Remove</button>
                  </form>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if a.ssid %}
                  <form method="post" action="/wifi/scope_map/set" class="row gap-sm m-0">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <input name="scope"
                      value="{{ a._mapped_scope or scope or preferred_scope or '' }}"
                      placeholder="10.0.10.0/24"
                      class="input-compact font-mono w-140">
                    <button class="btn secondary" type="submit">Set</button>
                  </form>
                  {% if a._mapped_scope %}
                    <div class="muted mt-xs">mapped</div>
                    <form method="post" action="/wifi/scope_map/remove" class="mt-sm">
                      <input type="hidden" name="ssid" value="{{ a.ssid }}">
                      <button class="btn secondary" type="submit">Undo</button>
                    </form>
                  {% endif %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if a._has_cred and a._allowed and a.ssid %}
                  <div class="row gap-sm">
                    <form method="post" action="/wifi/connect" class="m-0">
                      <input type="hidden" name="ssid" value="{{ a.ssid }}">
                      <input type="hidden" name="iface" value="{{ iface }}">
                      <button class="btn secondary" type="submit">Connect</button>
                    </form>
                    {% if wifi_profiles and a.ssid in wifi_profiles %}
                      <form method="post" action="/wifi/profile/apply" class="m-0">
                        <input type="hidden" name="ssid" value="{{ a.ssid }}">
                        <input type="hidden" name="iface" value="{{ iface }}">
                        <button class="btn secondary" type="submit">Apply profile</button>
                      </form>
                    {% endif %}
                  </div>
                {% elif a.ssid and not a._has_cred %}
                  <span class="muted">no creds</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
                {% if a.ssid %}
                  <form method="post" action="/wifi/profile/preset" class="row gap-sm mt-sm">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <select name="preset" class="input-compact">
                      <option value="safe">preset: safe</option>
                      <option value="stealth">preset: stealth</option>
                      <option value="fast">preset: fast</option>
                    </select>
                    <button class="btn secondary" type="submit">Apply preset</button>
                  </form>
                {% endif %}
                {% if a.ssid and (not profiles or a.ssid not in profiles) %}
                  <form method="post" action="/wifi/profile/create" class="mt-sm">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <button class="btn secondary" type="submit">Create profile</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="muted mt-md">Tip: Add credentials in config (wifi.credentials).</div>
    {% if targets_id %}
      <div class="muted mt-md">
        Target memory: <a class="pill" href="{{ url_for('artifact_view', artifact_id=targets_id) }}">Open</a>
        <a class="pill" href="{{ url_for('artifact_download', artifact_id=targets_id) }}">Download</a>
      </div>
    {% endif %}
  {% else %}
    <div class="muted">No scan data yet. Wait for the next scan tick.</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi credentials (lab-only)</h3>
  <div class="muted mb-sm">
    Format: <code>SSID=psk</code> (one per line). Saved into <code>[wifi.credentials]</code>
    in config.
  </div>

  <form method="post" action="/wifi/credentials/save">
    <textarea name="creds" spellcheck="false" class="code-area font-mono w-100 min-h-24">{% if app_cfg and app_cfg.wifi and app_cfg.wifi.credentials %}
{% for k,v in (app_cfg.wifi.credentials or {})|dictsort %}
{{ k }}={{ v }}
{% endfor %}
{% endif %}</textarea>

    <div class="row end mt-lg">
      <button class="btn" type="submit">Save</button>
      <button class="btn" type="submit" formaction="/wifi/credentials/save_reload" formmethod="post">Save + Reload</button>
    </div>
  </form>
</section>

<section class="card">
  <h3 class="h3-tight">WiFi profiles (per SSID)</h3>
  <div class="muted mb-sm">
    Format:
    <code>[SSID]</code> then <code>key=value</code>.
    Types: true/false, int/float, strings.
  </div>

  <form method="post" action="/wifi/profiles/save">
    <textarea name="profiles" spellcheck="false" class="code-area font-mono w-100 min-h-26">{% for ssid, p in (profiles or {})|dictsort %}
[{{ ssid }}]
{% for k,v in (p or {})|dictsort %}{{ k }}={{ v }}
{% endfor %}

{% endfor %}</textarea>

    {% if profile_hashes %}
      <div class="row gap-sm mt-md">
        {% for ssid, h in profile_hashes|dictsort %}
          <span class="pill">hash: {{ ssid }} · {{ h }}</span>
        {% endfor %}
      </div>
    {% endif %}

    <div class="row end mt-lg">
      <button class="btn" type="submit">Save</button>
      <button class="btn" type="submit" formaction="/wifi/profiles/save_reload" formmethod="post">Save + Reload</button>
    </div>
  </form>
</section>

<section class="card">
  <h3 class="h3-tight">Recent WiFi sessions</h3>
  <div class="events">
    {% for s in sessions %}
      <div class="evt">
        <div class="evt-top">{{ s.title }}</div>
        <div class="muted">id: {{ s.id }}</div>
        <div class="row mt-sm">
          <a class="pill" href="{{ url_for('artifact_view', artifact_id=s.id) }}">Open JSON</a>
          <a class="pill" href="{{ url_for('artifact_download', artifact_id=s.id) }}">Download</a>
          {% if s.report_id %}
            <a class="pill" href="{{ url_for('report_view', artifact_id=s.report_id) }}">Open HTML</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="muted">none yet</div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Profile selections (artifacts)</h3>
  {% if wifi_profile_selections and wifi_profile_selections|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>iface</th>
            <th>ssid</th>
            <th>profile_hash</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_profile_selections %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td><code>{{ p.get("wifi_profile_hash","-") }}</code></td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi → LAN timeline</h3>
  {% if wifi_lan_timeline and wifi_lan_timeline|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>ssid</th>
            <th>iface</th>
            <th>profile_hash</th>
            <th>job_id</th>
            <th>scope</th>
            <th>status</th>
            <th>links</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_lan_timeline %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            {% set jid = p.get("job_id","") %}
            {% set links = job_links(jid) if jid else {} %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td><code>{{ p.get("wifi_profile_hash","-") }}</code></td>
              <td><code>{{ jid if jid else "-" }}</code></td>
              <td><code>{{ p.get("scope","-") }}</code></td>
              <td>{{ job_status(jid) if jid else "-" }}</td>
              <td>
                {% if links and links.get("job_json") %}
                  <a class="pill" href="{{ links.get('job_json') }}">Job JSON</a>
                {% endif %}
                {% if links and links.get("bundle") %}
                  <a class="pill" href="{{ links.get('bundle') }}">Bundle</a>
                {% endif %}
                {% if links and links.get("report") %}
                  <a class="pill" href="{{ links.get('report') }}">Report</a>
                {% endif %}
                {% if links and links.get("dossier") %}
                  <a class="pill" href="{{ links.get('dossier') }}">Dossier</a>
                {% elif jid %}
                  <form method="post" action="/dossier/build" style="display:inline">
                    <input type="hidden" name="job_id" value="{{ jid }}">
                    <input type="hidden" name="scope" value="{{ p.get('scope','') }}">
                    <input type="hidden" name="back" value="{{ url_for('wifi') }}">
                    <button class="pill" type="submit">Build Dossier</button>
                  </form>
                {% endif %}
                {% if not links and not jid %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Connect attempts (artifacts)</h3>
  {% if wifi_connect_attempts and wifi_connect_attempts|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>iface</th>
            <th>ssid</th>
            <th>allowed</th>
            <th>has_cred</th>
            <th>ok</th>
            <th>note</th>
            <th>profile_hash</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_connect_attempts %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td>{{ p.get("allowed","-") }}</td>
              <td>{{ p.get("has_cred","-") }}</td>
              <td>{{ p.get("ok","-") }}</td>
              <td><small>{{ p.get("note","-") }}</small></td>
              <td><code>{{ p.get("wifi_profile_hash","-") }}</code></td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Connect results (artifacts)</h3>
  {% if wifi_connect_results and wifi_connect_results|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>iface</th>
            <th>ssid</th>
            <th>allowed</th>
            <th>has_cred</th>
            <th>ok</th>
            <th>note</th>
            <th>profile_hash</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_connect_results %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td>{{ p.get("allowed","-") }}</td>
              <td>{{ p.get("has_cred","-") }}</td>
              <td>{{ p.get("ok","-") }}</td>
              <td><small>{{ p.get("note","-") }}</small></td>
              <td><code>{{ p.get("wifi_profile_hash","-") }}</code></td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Disconnect attempts (artifacts)</h3>
  {% if wifi_disconnect_attempts and wifi_disconnect_attempts|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>iface</th>
            <th>ssid</th>
            <th>reason</th>
            <th>ok</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_disconnect_attempts %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td>{{ p.get("reason","-") }}</td>
              <td>{{ p.get("ok","-") }}</td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Disconnect results (artifacts)</h3>
  {% if wifi_disconnect_results and wifi_disconnect_results|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>iface</th>
            <th>ssid</th>
            <th>reason</th>
            <th>ok</th>
            <th>note</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_disconnect_results %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td>{{ p.get("iface","-") }}</td>
              <td>{{ p.get("ssid","-") }}</td>
              <td>{{ p.get("reason","-") }}</td>
              <td>{{ p.get("ok","-") }}</td>
              <td><small>{{ p.get("note","-") }}</small></td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">WiFi • Config patches (artifacts)</h3>
  {% if wifi_config_patches and wifi_config_patches|length > 0 %}
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr class="muted table-head">
            <th>ts</th>
            <th>patch_type</th>
            <th>summary</th>
            <th>before_hash</th>
            <th>after_hash</th>
            <th>snapshot</th>
            <th>artifact</th>
          </tr>
        </thead>
        <tbody>
          {% for row in wifi_config_patches %}
            {% set p = row.payload %}
            {% set a = row.meta %}
            {% set pt = p.get("patch_type","") %}
            <tr class="table-row">
              <td>{{ fmt_ts(p["ts"] if "ts" in p else None) }}</td>
              <td><code>{{ pt if pt else "-" }}</code></td>
              <td><small>{{ p.get("summary","-") }}</small></td>
              <td><code>{{ p["before_hash"][:12] ~ "…" if "before_hash" in p else "-" }}</code></td>
              <td><code>{{ p["after_hash"][:12] ~ "…" if "after_hash" in p else "-" }}</code></td>
              <td>
                {% if wifi_snap_by_patch_type and pt and pt in wifi_snap_by_patch_type %}
                  <a class="pill" href="{{ url_for('artifact_file_download', artifact_id=wifi_snap_by_patch_type[pt]) }}">Download</a>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td><code>{{ a.id }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="muted">-</div>
  {% endif %}
</section>

<section class="card">
  <h3 class="h3-tight">Recent WiFi events</h3>
  <div class="events">
    {% for e in events[:25] %}
      <div class="evt">
        <div class="evt-top">{{ e.topic }}</div>
        <pre>{{ e.payload }}</pre>
      </div>
    {% else %}
      <div class="muted">none</div>
    {% endfor %}
  </div>
</section>

{% endblock %}
