{% extends "layout.html" %}
{% block page_title %}WiFi{% endblock %}
{% block page_sub %}scan + connect (lab-safe){% endblock %}

{% block content %}

<section class="card">
  <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <div>
      <div class="muted">Interface</div>
      <div style="font-weight:900">{{ iface }}</div>
    </div>
    <div>
      <div class="muted">IPv4</div>
      <div style="font-weight:900">{{ ip_cidr or "—" }}</div>
    </div>
    <div>
      <div class="muted">Derived scope</div>
      <div style="font-weight:900">{{ scope or "—" }}</div>
    </div>
    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <a class="pill" href="{{ url_for('config') }}">Config</a>
      <a class="pill" href="{{ url_for('lan') }}">LAN</a>
      <a class="pill" href="{{ url_for('audit') }}">Audit</a>
      <form method="post" action="/wifi/disconnect" style="margin:0">
        <input type="hidden" name="iface" value="{{ iface }}">
        <button class="secondary" type="submit">Disconnect now</button>
      </form>
    </div>
  </div>

  <div style="margin-top:10px" class="row" style="gap:12px; flex-wrap:wrap;">
    <span class="pill">auto_connect: {{ "on" if auto_connect else "off" }}</span>
    {% if preferred_ssid %}
      <span class="pill">preferred: {{ preferred_ssid }}</span>
    {% endif %}
    {% if selected_profile_evt and selected_profile_evt.payload %}
      <span class="pill">profile selected: {{ selected_profile_evt.payload.get("ssid") or "—" }}</span>
    {% endif %}
    {% if conn_evt and conn_evt.payload %}
      <span class="pill">last connect: {{ conn_evt.payload.get("ssid") }} (ok={{ conn_evt.payload.get("ok") }})</span>
    {% endif %}
    {% if scan_evt and scan_evt.payload %}
      <span class="pill">last scan: {{ scan_evt.payload.get("count") }} APs</span>
    {% endif %}
    {% if health_evt and health_evt.payload %}
      <span class="pill">health: {{ "ok" if health_evt.payload.get("ok") else "bad" }}</span>
    {% endif %}
    {% if lan_locked %}
      <span class="pill">LAN lock active</span>
    {% endif %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">WiFi → LAN timeline</h3>
  <div class="events">
    {% for e in events[:30] %}
      {% if e.topic.startswith("wifi.") or e.topic.startswith("ui.wifi.") or e.topic.startswith("ui.lan.") or e.topic.startswith("lan.") %}
        <div class="evt">
          <div class="evt-top">{{ e.topic }}</div>
          <pre>{{ e.payload }}</pre>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Nearby APs</h3>

  {% if aps %}
    <div style="overflow:auto">
      <table style="width:100%; border-collapse:separate; border-spacing:0 10px;">
        <thead>
          <tr class="muted" style="text-align:left">
            <th style="padding:0 10px">SSID</th>
            <th style="padding:0 10px">BSSID</th>
            <th style="padding:0 10px">Signal</th>
            <th style="padding:0 10px">Seen</th>
            <th style="padding:0 10px">Best</th>
            <th style="padding:0 10px">Security</th>
            <th style="padding:0 10px">Freq</th>
            <th style="padding:0 10px">Allow</th>
            <th style="padding:0 10px">Scope</th>
            <th style="padding:0 10px">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for a in aps %}
            <tr style="background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); border-radius:14px;">
              <td style="padding:10px; font-weight:900;">
                {{ a.ssid or "(hidden)" }}
                {% if a._preferred %}<span class="pill">preferred</span>{% endif %}
                {% if not a._allowed %}<span class="pill">blocked</span>{% endif %}
              </td>
              <td style="padding:10px" class="muted">{{ a.bssid }}</td>
              <td style="padding:10px">{{ a.signal }} dBm</td>
              <td style="padding:10px">{{ a._seen_count or 0 }}</td>
              <td style="padding:10px">{{ a._strongest if a._strongest is not none else "—" }}</td>
              <td style="padding:10px">{{ a.sec or "unknown" }}</td>
              <td style="padding:10px">{{ a.freq or "" }}</td>
              <td style="padding:10px">
                {% if a.ssid and (not a._allowed) %}
                  <form method="post" action="/wifi/allowlist/add" style="margin:0">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <button class="secondary" type="submit">Allow</button>
                  </form>
                {% elif a.ssid and a._allowed %}
                  <form method="post" action="/wifi/allowlist/remove" style="margin:0" class="row">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <button class="secondary" type="submit">Remove</button>
                  </form>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td style="padding:10px">
                {% if a.ssid %}
                  <form method="post" action="/wifi/scope_map/set" class="row" style="gap:8px; flex-wrap:wrap; margin:0">
                    <input type="hidden" name="ssid" value="{{ a.ssid }}">
                    <input name="scope"
                      value="{{ a._mapped_scope or scope or preferred_scope or '' }}"
                      placeholder="10.0.10.0/24"
                      style="width:140px; background:#0f1722; color:#e7eef7; border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:8px 10px; font-family: ui-monospace,monospace; font-size:12px;">
                    <button class="secondary" type="submit">Set</button>
                  </form>
                  {% if a._mapped_scope %}
                    <div class="muted" style="margin-top:6px">mapped</div>
                    <form method="post" action="/wifi/scope_map/remove" style="margin-top:8px">
                      <input type="hidden" name="ssid" value="{{ a.ssid }}">
                      <button class="secondary" type="submit">Undo</button>
                    </form>
                  {% endif %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td style="padding:10px">
                {% if a._has_cred and a._allowed and a.ssid %}
                  <div class="row" style="gap:8px; flex-wrap:wrap;">
                    <form method="post" action="/wifi/connect" style="margin:0">
                      <input type="hidden" name="ssid" value="{{ a.ssid }}">
                      <input type="hidden" name="iface" value="{{ iface }}">
                      <button class="secondary" type="submit">Connect</button>
                    </form>
                    {% if wifi_profiles and a.ssid in wifi_profiles %}
                      <form method="post" action="/wifi/profile/apply" style="margin:0">
                        <input type="hidden" name="ssid" value="{{ a.ssid }}">
                        <input type="hidden" name="iface" value="{{ iface }}">
                        <button class="secondary" type="submit">Apply profile</button>
                      </form>
                    {% endif %}
                  </div>
                {% elif a.ssid and not a._has_cred %}
                  <span class="muted">no creds</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:10px">Tip: Add credentials in config (wifi.credentials).</div>
    {% if targets_id %}
      <div class="muted" style="margin-top:10px">
        Target memory: <a class="pill" href="{{ url_for('artifact_view', artifact_id=targets_id) }}">Open</a>
        <a class="pill" href="{{ url_for('artifact_download', artifact_id=targets_id) }}">Download</a>
      </div>
    {% endif %}
  {% else %}
    <div class="muted">No scan data yet. Wait for the next scan tick.</div>
  {% endif %}
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">WiFi credentials (lab-only)</h3>
  <div class="muted" style="margin-bottom:10px">
    Format: <code>SSID=psk</code> (one per line). Saved into <code>[wifi.credentials]</code>
    in config.
  </div>

  <form method="post" action="/wifi/credentials/save">
    <textarea name="creds" spellcheck="false"
      style="width:100%; min-height:24vh; resize:vertical; background:#0f1722; color:#e7eef7; border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; font-family: ui-monospace,monospace; font-size:12px; line-height:1.4;"
    >{% if app_cfg and app_cfg.wifi and app_cfg.wifi.credentials %}
{% for k,v in (app_cfg.wifi.credentials or {})|dictsort %}
{{ k }}={{ v }}
{% endfor %}
{% endif %}</textarea>

    <div class="row" style="justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;">
      <button class="btn" type="submit">Save</button>
      <button class="btn" type="submit" formaction="/wifi/credentials/save_reload" formmethod="post">Save + Reload</button>
    </div>
  </form>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">WiFi profiles (per SSID)</h3>
  <div class="muted" style="margin-bottom:10px">
    Format:
    <code>[SSID]</code> then <code>key=value</code>.
    Types: true/false, int/float, strings.
  </div>

  <form method="post" action="/wifi/profiles/save">
    <textarea name="profiles" spellcheck="false"
      style="width:100%; min-height:26vh; resize:vertical; background:#0f1722; color:#e7eef7; border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; font-family: ui-monospace,monospace; font-size:12px; line-height:1.4;"
    >{% for ssid, p in (profiles or {})|dictsort %}
[{{ ssid }}]
{% for k,v in (p or {})|dictsort %}{{ k }}={{ v }}
{% endfor %}

{% endfor %}</textarea>

    <div class="row" style="justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;">
      <button class="btn" type="submit">Save</button>
      <button class="btn" type="submit" formaction="/wifi/profiles/save_reload" formmethod="post">Save + Reload</button>
    </div>
  </form>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Recent WiFi sessions</h3>
  <div class="events">
    {% for s in sessions %}
      <div class="evt">
        <div class="evt-top">{{ s.title }}</div>
        <div class="muted">id: {{ s.id }}</div>
        <div class="row" style="gap:10px; margin-top:8px; flex-wrap:wrap;">
          <a class="pill" href="{{ url_for('artifact_view', artifact_id=s.id) }}">Open JSON</a>
          <a class="pill" href="{{ url_for('artifact_download', artifact_id=s.id) }}">Download</a>
          {% if s.report_id %}
            <a class="pill" href="{{ url_for('report_view', artifact_id=s.report_id) }}">Open HTML</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="muted">none yet</div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Recent WiFi events</h3>
  <div class="events">
    {% for e in events[:25] %}
      <div class="evt">
        <div class="evt-top">{{ e.topic }}</div>
        <pre>{{ e.payload }}</pre>
      </div>
    {% else %}
      <div class="muted">none</div>
    {% endfor %}
  </div>
</section>

{% endblock %}
