{% extends "layout.html" %}
{% block page_title %}Result Details{% endblock %}
{% block page_sub %}Job {{ bundle.job_id }} • {{ bundle.kind }} • {{ bundle.scope }}{% endblock %}

{% block content %}
<section class="card">
  <h3 style="margin:0 0 10px 0">Links</h3>
  <div class="row">
    {% if result_json_id %}
      <a href="{{ url_for('artifact_download', artifact_id=result_json_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">Download result JSON</a>
      <a href="{{ url_for('artifact_view', artifact_id=result_json_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">View result JSON</a>
    {% endif %}

    {% if report_id %}
      <a href="{{ url_for('report_view', artifact_id=report_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">Open report (HTML)</a>
      <a href="{{ url_for('artifact_file_download', artifact_id=report_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">Download report</a>
    {% else %}
      <span class="muted">No report generated (reports disabled).</span>
    {% endif %}
    {% if report_md_id %}
      <a href="{{ url_for('artifact_file_download', artifact_id=report_md_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">Download report (MD)</a>
    {% endif %}
    {% if report_json_id %}
      <a href="{{ url_for('artifact_file_download', artifact_id=report_json_id) }}"
         style="color:var(--accent); text-decoration:none; font-weight:900;">Download report (JSON)</a>
    {% endif %}

    <a href="{{ url_for('artifact_download', artifact_id=bundle_id) }}"
       style="color:var(--accent); text-decoration:none; font-weight:900;">Download bundle JSON</a>
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Bundle metadata</h3>
  <div class="evt"><pre>{{ bundle }}</pre></div>
</section>

{% if result_json %}
<section class="card">
  <h3 style="margin:0 0 10px 0">Result JSON (preview)</h3>
  <div class="evt"><pre>{{ result_json }}</pre></div>
</section>
{% endif %}

{% set steps = [] %}
{% if result_json is mapping and (result_json.get('steps') is not none) %}
  {% set steps = result_json.get('steps') %}
{% elif bundle is mapping and (bundle.get('steps') is not none) %}
  {% set steps = bundle.get('steps') %}
{% endif %}

<section class="card">
  <h3 style="margin:0 0 10px 0">Steps</h3>
  <div class="events">
    {% for s in steps %}
      <div class="evt">
        <div class="evt-top">
          #{{ s.step if s.step is defined else loop.index }} • {{ s.action if s.action is defined else (s.action_id if s.action_id is defined else 'step') }}
        </div>
        {% if s.duration_s is defined %}
          <pre>duration={{ s.duration_s }}s{% if s.score is defined and s.score is not none %} • score={{ s.score }}{% endif %}</pre>
        {% endif %}
        {% include "partials/step_links_inline.html" %}
        {% if s.why is defined and s.why %}
          <div class="muted" style="margin-top:8px">why</div>
          <pre>{{ s.why }}</pre>
        {% endif %}
        {% if s.result_summary is defined and s.result_summary %}
          <div class="muted" style="margin-top:8px">result</div>
          <pre>{{ s.result_summary | tojson(indent=2) }}</pre>
        {% endif %}
      </div>
    {% else %}
      <div class="muted">No steps in this result.</div>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0">Job events (latest)</h3>
  <div class="events">
    {% for e in events %}
      <div class="evt">
        <div class="evt-top">{{ e.topic }}</div>
        <pre>{{ e.payload }}</pre>
      </div>
    {% else %}
      <div class="muted">No matching events found.</div>
    {% endfor %}
  </div>
</section>
{% endblock %}
