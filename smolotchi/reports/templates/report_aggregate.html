<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title }}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0b1016;color:#e7eef7;margin:0;padding:18px}
    a{color:#5fd1ff;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#111a24;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(95,209,255,.10);border:1px solid rgba(95,209,255,.18);color:#5fd1ff;font-weight:700;font-size:12px}
    .muted{color:rgba(231,238,247,.70);font-size:12px}
    .kvs{display:grid;grid-template-columns: 160px 1fr;gap:6px 12px;margin-top:8px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .ports{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:4px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-weight:700;font-size:12px}
    .sev{padding:4px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid rgba(255,255,255,.10)}
    .alert{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);margin-top:12px}
    .alert.warn{background:rgba(255,170,80,.10);border-color:rgba(255,170,80,.2)}
    .sev-info{background:rgba(255,255,255,.04)}
    .sev-low{background:rgba(120,255,170,.10)}
    .sev-medium{background:rgba(255,210,120,.12)}
    .sev-high{background:rgba(255,140,120,.14)}
    .sev-critical{background:rgba(255,90,90,.18)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;text-align:left;vertical-align:top}
    th{color:rgba(231,238,247,.75);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:900;font-size:18px">{{ title }}</div>
        <div class="muted">Plan: <span class="mono">{{ plan_id }}</span> · Scope: <span class="mono">{{ scope }}</span> · {{ ts_human }}</div>
      </div>
      <div class="row">
        {% if bundle_id %}
          <a class="tag" href="/lan/result/{{ bundle_id }}">Result Details</a>
        {% endif %}
        {% if host_summary_artifact_id %}
          <a class="tag" href="/artifact/{{ host_summary_artifact_id }}">Host Summary JSON</a>
        {% endif %}
      </div>
    </div>
  </div>

  <section class="card">
    <h2>Applied profile</h2>
    {% if applied %}
      <div class="row pills">
        {% if applied.wifi_ssid %}<span class="pill">ssid: {{ applied.wifi_ssid }}</span>{% endif %}
        {% if applied.wifi_iface %}<span class="pill">iface: {{ applied.wifi_iface }}</span>{% endif %}
        {% if applied.effective and applied.effective.scope %}<span class="pill">scope: {{ applied.effective.scope }}</span>{% endif %}
        {% if applied.effective and applied.effective.pack %}<span class="pill">pack: {{ applied.effective.pack }}</span>{% endif %}
        {% if applied.effective and applied.effective.throttle_rps is not none %}<span class="pill">rps: {{ applied.effective.throttle_rps }}</span>{% endif %}
        {% if applied.effective and applied.effective.batch_size is not none %}<span class="pill">batch: {{ applied.effective.batch_size }}</span>{% endif %}
        {% if applied.wifi_profile_hash %}<span class="pill">profile-hash: {{ applied.wifi_profile_hash }}</span>{% endif %}
      </div>

      {% if profile_drift and profile_drift.drift %}
        <div class="alert warn">
          ⚠ Profile drift detected<br>
          Applied: {{ profile_drift.applied_hash }}<br>
          Current: {{ profile_drift.current_hash }}
        </div>
      {% endif %}

      {% if applied.wifi_profile_json %}
        <h3 style="margin-top:14px">Profile data</h3>
        <pre>{{ applied.wifi_profile_json }}</pre>
      {% endif %}

      {% if applied.lan_overrides_json %}
        <h3 style="margin-top:14px">Job overrides</h3>
        <pre>{{ applied.lan_overrides_json }}</pre>
      {% endif %}
    {% endif %}
  </section>

  {% for host in hosts %}
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900;font-size:16px">{{ host.ip }}</div>
        <div class="row">
          <span class="sev sev-{{ host.sev_highest }}">{{ host.sev_highest | upper }}</span>
          <span class="tag">fp http {{ (host.fp_by_key.http or "")[:8] }}</span>
          <span class="tag">fp ssh {{ (host.fp_by_key.ssh or "")[:8] }}</span>
          <span class="tag">fp smb {{ (host.fp_by_key.smb or "")[:8] }}</span>
        </div>
      </div>

      <div class="kvs">
        <div class="muted">Open Ports</div>
        <div class="ports">
          {% for p in host.open_ports %}
            <span class="pill">{{ p }}</span>
          {% else %}
            <span class="muted">—</span>
          {% endfor %}
        </div>

        <div class="muted">HTTP Ports</div>
        <div class="mono">{{ host.ports_by_key.http | join(", ") if host.ports_by_key.http else "—" }}</div>

        <div class="muted">SSH Ports</div>
        <div class="mono">{{ host.ports_by_key.ssh | join(", ") if host.ports_by_key.ssh else "—" }}</div>

        <div class="muted">SMB Ports</div>
        <div class="mono">{{ host.ports_by_key.smb | join(", ") if host.ports_by_key.smb else "—" }}</div>
      </div>

      <div style="margin-top:12px;font-weight:900">Top Badges</div>
      {% if host.badges and host.badges|length > 0 %}
        <div class="ports" style="margin-top:6px">
          {% for b in host.badges %}
            <span class="pill mono">{{ b }}</span>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No notable findings.</div>
      {% endif %}

      <div class="muted" style="margin-top:8px">
        counts: C={{ host.sev_counts.critical or 0 }} · H={{ host.sev_counts.high or 0 }} · M={{ host.sev_counts.medium or 0 }} · L={{ host.sev_counts.low or 0 }} · I={{ host.sev_counts.info or 0 }}
      </div>

      <div style="margin-top:12px;font-weight:900">Findings (safe)</div>
      {% if host.findings.scripts and host.findings.scripts|length > 0 %}
        <table>
          <thead>
            <tr>
              <th style="width:110px">Severity</th>
              <th style="width:90px">CVSS</th>
              <th style="width:110px">Tag</th>
              <th style="width:140px">Scope</th>
              <th style="width:220px">Script</th>
              <th>Output (snippet)</th>
            </tr>
          </thead>
          <tbody>
            {% for f in host.findings.scripts[:12] %}
              <tr>
                <td class="mono">{{ f.severity }}</td>
                <td class="mono">{{ f.cvss if f.cvss is not none else "—" }}</td>
                <td class="mono">{{ f.tag }}</td>
                <td class="mono">{{ f.scope }}</td>
                <td class="mono">{{ f.id }}</td>
                <td class="mono">{{ f.output }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if host.findings.scripts|length > 12 %}
          <div class="muted" style="margin-top:6px">Showing first 12 findings. Open JSON artifacts for full outputs.</div>
        {% endif %}
      {% else %}
        <div class="muted">No script findings extracted.</div>
      {% endif %}

      <div style="margin-top:12px;font-weight:900">Findings / Artifacts</div>
      <table>
        <thead>
          <tr>
            <th style="width:220px">Action</th>
            <th>Summary</th>
            <th style="width:220px">Links</th>
          </tr>
        </thead>
        <tbody>
          {% for a in host.actions %}
            <tr>
              <td class="mono">{{ a.action_id }}</td>
              <td class="muted">{{ a.summary }}</td>
              <td>
                <a href="/artifact/{{ a.artifact_id }}">Open JSON</a>
                · <a href="/artifact/{{ a.artifact_id }}/download">Download</a>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="3" class="muted">No artifacts</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}

  <div class="card">
    <div class="muted">Generated by Smolotchi · aggregate report</div>
  </div>
</div>
</body>
</html>
